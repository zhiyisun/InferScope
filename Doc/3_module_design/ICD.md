<!-- AUTO-GENERATED from interfaces.yaml -->
<!-- Do not edit this file directly. Edit interfaces.yaml and run: python scripts/generate_icd.py -->

# Interface Control Document (ICD)

## Overview
This document defines all inter-module APIs, data formats, and communication contracts for InferScope.

## Python API (User-Facing)

### scope()

**Description:** Context manager for marking inference regions

**Signature:**
```python
scope(name: str)
```

**Methods:**
- `__enter__() -> scope`
- `__exit__(exc_type, exc_val, exc_tb) -> None`

**Output Events:**
- `scope_enter`
- `scope_exit`

**Example:**
```python
with scope("inference"):
    output = model.forward(inputs)
```

---

### mark_event()

**Description:** Instant event marker with optional metadata

**Signature:**
```python
mark_event(name: str, metadata: Optional[Dict]) -> None
```

**Output Events:**
- `instant`

**Example:**
```python
mark_event("tokenization_complete", metadata={"tokens": 1024})
```

---

## CLI Interface

### `run` Command

**Description:** Execute script with InferScope tracing

**Usage:**
```bash
inferscope run [OPTIONS] SCRIPT [ARGS...]
```

**Options:**
- `--report`: Output report file path (default: report.md)
- `--log-level`: Logging verbosity: debug, info, warn (default: info)
- `--trace-size-mb`: Ring buffer size in MB (default: 100)

**Behavior:**
1. Execute script with INFERSCOPE_ENABLED=1
2. Collect traces during execution
3. Generate report on completion
4. Exit with script's exit code

---

### `analyze` Command

**Description:** Analyze existing trace file

**Usage:**
```bash
inferscope analyze TRACE_FILE [OPTIONS]
```

**Options:**
- `--output`: Output report file path (default: report.md)
- `--rules-file`: Custom bottleneck rules YAML

**Behavior:**
1. Load trace from TRACE_FILE
2. Run analyzer engine
3. Generate report

---

## Internal Module APIs

### Cpu Collector

**Output Format:** JSON event stream

**Event Schema:**
```yaml
event_type: string (cpu_call, cpu_syscall, memory_alloc)
name: string
start_us: integer
end_us: integer
thread_id: integer
cpu_id: integer
```

**Thread Safety:** Per-thread lock-free buffer

---

### Gpu Collector

**Output Format:** JSON event stream

**Event Schema:**
```yaml
event_type: string (gpu_kernel, h2d_copy, d2h_copy)
name: string
start_us: integer
end_us: integer
device_id: integer
grid_dim: array[3]
block_dim: array[3]
bytes: integer (for memory copies)
```

**Thread Safety:** Main thread only; async callbacks

---

### Trace Buffer

**Interface:**
- `enqueue(event: Dict) -> bool`
- `read_all() -> List[Dict]`
- `clear() -> None`

---

### Timeline Merger

**Methods:**
- `synchronize_clocks() -> None`
- `get_sorted_events() -> List[Dict]`

**Input:** Unsorted events with mixed timestamps

**Output:** Sorted events with unified global timestamps

**Clock Sync Method:** CUDA event + CPU rdtsc calibration

**Accuracy Target:** <1% error

---

### Analyzer Engine

**Methods:**
- `analyze() -> Dict[str, Any]`

**Bottleneck Detection Rules:**
- GPU idle detection (>10%)
- PCIe saturation (H2D+D2H throughput)
- CPU threading contention
- Memory pressure

**Input:** Sorted unified timeline

**Output:** Bottleneck classification and suggestions

---

### Report Generator

**Methods:**
- `to_markdown() -> str`
- `to_html() -> str`
- `to_json() -> Dict`

**Input:** Analysis results + timeline

**Output Formats:** ['Markdown', 'HTML', 'JSON']

---

## Configuration

### Environment Variables

- `INFERSCOPE_ENABLED`: Enable/disable tracing (1/0)
- `INFERSCOPE_LOG_LEVEL`: debug, info, warn, error
- `INFERSCOPE_TRACE_SIZE_MB`: Ring buffer size (default: 100)
- `INFERSCOPE_SYNC_ERROR_MARGIN_US`: Clock sync uncertainty (default: 1000)

**Config File Format:** YAML (.inferscope.yaml)

**Precedence:** CLI args > env vars > config file > defaults

---

## Error Handling

| Error | Collector Response | User Impact | Level |
|-------|-------------------|-------------|-------|
| Cuda Unavailable | Skip GPU events, continue with CPU | CPU-only analysis | warn |
| Cupti Load Fails | Fallback to NVIDIA profiler if available | Reduced GPU visibility | warn |
| Trace Buffer Overflow | Wrap oldest events; log warning | Possible data loss | warn |
| Clock Sync Fails | Use conservative margin; annotate in report | Timestamp uncertainty in results | warn |

